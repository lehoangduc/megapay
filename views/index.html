<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Payment</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3"
      crossorigin="anonymous"
    />
    <script
      src="https://code.jquery.com/jquery-3.6.0.min.js"
      integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4="
      crossorigin="anonymous"
    ></script>
    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"
      integrity="sha384-ka7Sk0Gln4gmtz2MlQnikT1wXgYsOg+OMhuP+IlRH9sENBO0LRn5q+8nbTov4+1p"
      crossorigin="anonymous"
    ></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.loadtemplate/1.2.2/jquery.loadTemplate.min.js" integrity="sha512-4TNloTjrSDYjXOIkusiCx1L1n7KrBLENxj/zsM5a1XeA9KT3Chb+7mPHFzopYxf7IeEpP8ReekhSUHWO99vuYA==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script
      type="text/javascript"
      src="https://sandbox.megapay.vn:2810/pg_was/js/payment/layer/paymentClient.js"
    ></script>
  </head>

  <script type="text/html" id="paymentCardsTemplate">
    <tr>
      <td data-content="card_no"></td>
      <td data-content="action-delete">
        <input class="form-check-input" type="radio" name="cardToken" data-value="payment_token" />
        <a href="#">Delete</a>
      </td>
    </tr>
  </script>

  <body>
    <div class="m-4">
      <form id="megapayForm" name="megapayForm" method="POST">
        <div class="row">
          <div class="col-md-4">
          <div class="btn-group" role="group">
            <input
              id="useExistingCard"
              name="useExistingCard"
              type="checkbox"
              class="btn-check"
              autocomplete="off"
              value="true"
            />
            <label class="btn btn-outline-primary" for="useExistingCard">Dùng thẻ có sẵn?</label>
          </div>
          <table id="paymentCards" class="table table-sm">
            <thead>
              <tr>
                <th scope="col">Card</th>
                <th scope="col">Action</th>
              </tr>
            </thead>
            <tbody>
            </tbody>
          </table>
        </div>

        <div class="row">
          <div class="row mb-3">
            <label class="col-sm-2 col-form-label">Fullname</label>
            <div class="col-sm-10">
              <input
                type="fullname"
                class="form-control"
                placeholder="Full name"
                name="fullname"
                value="nguyen van a"
              />
            </div>
          </div>

          <div class="row mb-3">
            <label class="col-sm-2 col-form-label">Method</label>
            <div class="col-sm-10">
              <div class="btn-group" role="group">
                <input
                  id="atm"
                  type="radio"
                  class="btn-check"
                  name="method"
                  autocomplete="off"
                  checked
                  value="atm"
                />
                <label class="btn btn-outline-primary" for="atm">ATM</label>

                <input
                  id="visa"
                  type="radio"
                  class="btn-check"
                  name="method"
                  autocomplete="off"
                  value="visa"
                />
                <label class="btn btn-outline-primary" for="visa"
                  >Visa/Master</label
                >

                <input
                  id="zalo"
                  type="radio"
                  class="btn-check"
                  name="method"
                  autocomplete="off"
                  value="zalo"
                />
                <label class="btn btn-outline-primary" for="zalo">Zalo</label>

                <input
                  id="momo"
                  type="radio"
                  class="btn-check"
                  name="method"
                  value="momo"
                  autocomplete="off"
                  value="momo"
                />
                <label class="btn btn-outline-primary" for="momo">Momo</label>

                <input
                  id="moca"
                  type="radio"
                  class="btn-check"
                  name="method"
                  autocomplete="off"
                  value="moca"
                />
                <label class="btn btn-outline-primary" for="moca">Moca</label>
              </div>
            </div>
          </div>

          <div class="row mb-3">
            <label class="col-sm-2 col-form-label">Lưu thông tin thẻ?</label>
            <div class="col-sm-10">
              <div class="form-check">
                <input class="form-check-input" type="checkbox" name="isCardSaved" value="true">
              </div>
            </div>

          <div class="row">
            <div class="col-sm-10 offset-sm-2">
              <input type="hidden" name="merId" value="" />
              <input type="hidden" name="merTrxId" value="" />
              <input type="hidden" name="merchantToken" value="" />
              <input type="hidden" name="payOption" value="" />
              <input type="hidden" name="payToken" value="" />
              <input type="hidden" name="currency" value="VND" />
              <input type="hidden" name="invoiceNo" value="" />
              <input type="hidden" name="goodsNm" value="" />
              <input type="hidden" name="description" value="" />
              <input type="hidden" name="userId" value="" />
              <input type="hidden" name="buyerFirstNm" value="" />
              <input type="hidden" name="buyerLastNm" value="" />
              <input type="hidden" name="payType" value="" />
              <input type="hidden" name="bankCode" value="" />
              <input type="hidden" name="amount" value="" />
              <input type="hidden" name="fee" value="0" />

              <input type="hidden" name="windowType" value="1" />
              <input type="hidden" name="userLanguage" value="VN" />
              <input type="hidden" name="callBackUrl" value="" />
              <input type="hidden" name="notiUrl" value="" />
              <input type="hidden" name="reqDomain" value="" />
              <input type="hidden" name="timeStamp" value="" />
              <button type="submit" class="btn btn-primary">Submit</button>
            </div>
          </div>
        </div>
      </form>
    </div>

    <script>
      const BASE_URL = 'http://localhost:8080';
      const NOTIFY_URL = 'http://localhost:8080/notify';
      const $form = $('#megapayForm');

      const getPayTypes = (method) => {
        switch (method) {
          case 'atm':
            return { type: 'DC', bank: '' };

          case 'visa':
            return { type: 'IC', bank: '' };

          default:
            return { type: 'EW', bank: method.toUpperCase() };
        }
      };

      const getFormValues = (values) => {
        const params = {};

        $.each(values, function (_, kv) {
          params[kv.name] = kv.value;
        });

        return params;
      };

      // get cards
      $.ajax(BASE_URL + '/users/1/cards')
        .done((res) => {
          if (!res.data) return

          $('#paymentCards tbody').loadTemplate($('#paymentCardsTemplate'), res.data);
        })

      // payment token change
      $('#useExistingCard').on('change', function () {
        const checked = $(this).is(':checked')

        if (checked) {
          $('input[name=isCardSaved]').prop('checked', false);
        }
        
        $('input[name=isCardSaved]').prop('disabled', checked);
      })

      $form.on('submit', function (e) {
        e.preventDefault();

        const params = getFormValues($form.serializeArray());

        $.ajax({
          url: BASE_URL + '/transactions',
          type: 'POST',
          dataType: 'json',
          data: JSON.stringify(params),
          contentType: 'application/json',
          success: function (res) {
            const { domain, firstName, lastName } = res;
            const { type: payType, bank: bankCode } = getPayTypes(
              params.method
            );
            const isCardSaved = $form.find('[name=isCardSaved]').is(":checked")
            const useExistingCard = $('#useExistingCard').is(":checked")

            $form.find('[name=callBackUrl]').val(res.callBackUrl);
            $form.find('[name=notiUrl]').val(res.notiUrl);
            $form.find('[name=reqDomain]').val(BASE_URL);

            $form.find('[name=payOption]').val(res.payOption);
            $form.find('[name=payToken]').val(res.payToken);
            $form.find('[name=payType]').val(payType);
            $form.find('[name=bankCode]').val(bankCode);

            $form.find('[name=goodsNm]').val(`DON HANG ${res.invoiceNo}`);
            $form.find('[name=userId]').val(res.userId);
            $form.find('[name=buyerFirstNm]').val(res.firstName);
            $form.find('[name=buyerLastNm]').val(res.lastName);
            $form.find('[name=description]').val(res.description);
            $form.find('[name=timeStamp]').val(res.timeStamp);
            $form.find('[name=invoiceNo]').val(res.invoiceNo);
            $form.find('[name=merTrxId]').val(res.merTrxId);
            $form.find('[name=merId]').val(res.merId);
            $form.find('[name=merchantToken]').val(res.merchantToken);
            $form.find('[name=amount]').val(res.amount);

            console.log(getFormValues($form.serializeArray()));

            openPayment(1, domain);
          },
          error: function () {
            alert('Có lỗi trong quá trình xử lý 123!');
          },
        });
      });
    </script>
  </body>
</html>
